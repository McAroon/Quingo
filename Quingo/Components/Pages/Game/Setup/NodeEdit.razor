<MudCard>
    @if (_isEditMode)
    {
        <MudCardContent>
            <MudForm @ref="@_form">
                <MudText Typo="Typo.h6">Item info</MudText>
                <MudTextField Label="Name" Required @bind-Value="@_model.Name" />
                <MudTextField Label="Image Url" @bind-Value="@_model.ImageUrl" />
                <MudSelect T="int" MultiSelection Label="Tags" @bind-SelectedValues="@_model.TagIds" MultiSelectionTextFunc="GetTagsSelectText">
                    @foreach (var tag in Node.Pack.Tags)
                    {
                        <MudSelectItem T="int" Value="@tag.Id">@tag.Name</MudSelectItem>
                    }
                </MudSelect>


                <MudText Typo="Typo.h6">Item Links <MudTooltip Text="Add Link"><MudIconButton OnClick="AddLink" Icon="@Icons.Material.Filled.Add"></MudIconButton></MudTooltip></MudText>
                @foreach (var link in _model.NodeLinks)
                {
                    <MudPaper Class="pa-4 mb-2">
                        <MudGrid>
                            <MudItem xs="12">
                                <MudSelect T="NodeLinkDirection" Label="Link Direction" @bind-Value="@link.LinkDirection">
                                    <MudSelectItem Value="NodeLinkDirection.From"><MudIcon Size="Size.Small" Icon="@GetDirectionIcon(NodeLinkDirection.From)" Class="icon-inline-select" /> From</MudSelectItem>
                                    <MudSelectItem Value="NodeLinkDirection.To"><MudIcon Size="Size.Small" Icon="@GetDirectionIcon(NodeLinkDirection.To)" Class="icon-inline-select" /> To</MudSelectItem>
                                    <MudSelectItem Value="NodeLinkDirection.Both"><MudIcon Size="Size.Small" Icon="@GetDirectionIcon(NodeLinkDirection.Both)" Class="icon-inline-select" /> Both</MudSelectItem>
                                </MudSelect>
                                <MudAutocomplete T="NodeInfoModel" Label="Link Item" @bind-Value="@link.LinkedNode" SearchFunc="SearchNode" ToStringFunc="x => x?.Name" ResetValueOnEmptyText Clearable Required />
                                <MudSelect T="int?" Label="Link Type" @bind-Value="@link.LinkTypeId" Required>
                                    @foreach (var linkType in Node.Pack.NodeLinkTypes)
                                    {
                                        <MudSelectItem T="int?" Value="@linkType.Id">@linkType.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" Class="d-flex">
                                <div class="ml-auto">
                                    <MudTooltip Text="Remove Link">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" OnClick="() => DeleteLink(link)" />
                                    </MudTooltip>
                                </div>
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                }
            </MudForm>
        </MudCardContent>
        <MudCardActions>
            <div class="ml-auto">
                <MudButton Color="Color.Primary" OnClick="Save" StartIcon="@Icons.Material.Filled.Save">Save</MudButton>
                <MudButton Color="Color.Secondary" OnClick="CancelEdit" StartIcon="@Icons.Material.Filled.Cancel">Cancel</MudButton>
            </div>
        </MudCardActions>
    }
    else
    {
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5">
                    @_model.Name
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudTooltip Text="Edit Item">
                    <MudIconButton OnClick="() => _isEditMode = true" Icon="@Icons.Material.Filled.Edit"></MudIconButton>
                </MudTooltip>
                <MudTooltip Text="Delete Item">
                    <MudIconButton OnClick="Delete" Icon="@Icons.Material.Filled.Delete"></MudIconButton>
                </MudTooltip>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" GutterBottom>Tags</MudText>
                    @if (_model.TagIds.Any())
                    {
                        @foreach (var tag in GetTagNames(_model.TagIds))
                        {
                            <MudChip T="string" Variant="Variant.Text" Color="Color.Info">@tag</MudChip>
                        }
                    }
                    else
                    {
                        <i>none</i>
                    }
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6" GutterBottom>Linked Items</MudText>
                    @if (_model.NodeLinks.Any())
                    {
                        <MudTable Items="_model.NodeLinks">
                            <HeaderContent>
                                <MudTh>Direction</MudTh>
                                <MudTh>Item</MudTh>
                                <MudTh>Type</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd><MudIcon Icon="@GetDirectionIcon(context.LinkDirection)" Class="icon-inline" /> <span>@context.LinkDirection</span></MudTd>
                                <MudTd>@context.LinkedNode?.Name</MudTd>
                                <MudTd>@GetLinkTypeName(context.LinkTypeId)</MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                    else
                    {
                        <i>none</i>
                    }
                </MudItem>
            </MudGrid>
        </MudCardContent>
    }
</MudCard>

@code {
    [Parameter]
    public Node Node { get; set; } = default!;

    [Parameter]
    public Func<int, NodeModel, Task>? OnSave { get; set; }

    [Parameter]
    public Func<int, Task>? OnDelete { get; set; }

    private NodeModel _model = default!;

    private bool _isEditMode;

    private MudForm _form = default!;


    private IEnumerable<Node> LinkableNodes => Node.Pack.Nodes.Where(
        x => x.DeletedAt == null && x != Node && !_model.NodeLinks.Select(y => y.LinkedNodeId).Contains(x.Id));

    private string GetDirectionIcon(NodeLinkDirection direction) => direction switch
    {
        NodeLinkDirection.From => Icons.Material.Filled.ChevronRight,
        NodeLinkDirection.To => Icons.Material.Filled.ChevronLeft,
        NodeLinkDirection.Both => Icons.Material.Filled.Code,
        _ => ""
    };

    protected override void OnParametersSet()
    {
        RemapModel();
    }

    private void RemapModel()
    {
        _model = MapModel();
        StateHasChanged();
    }

    private NodeModel MapModel()
    {
        var fromIds = Node.NodeLinksFrom.Where(x => x.DeletedAt == null).Select(x => (id: x.NodeToId, name:x.NodeTo.Name, linkId: x.NodeLinkTypeId)).ToList();
        var toIds = Node.NodeLinksTo.Where(x => x.DeletedAt == null).Select(x => (id: x.NodeFromId, name: x.NodeFrom.Name, linkId: x.NodeLinkTypeId)).ToList();
        var bothIds = fromIds.Join(toIds, x => x.id, y => y.id, (x, y) => x).ToList();
        var linksFrom = fromIds.Except(bothIds).Select(x => new NodeLinkModel
            {
                LinkedNode = new NodeInfoModel { Id = x.id, Name = x.name! },
                LinkTypeId = x.linkId,
                LinkDirection = NodeLinkDirection.From
            });
        var linksTo = toIds.Except(bothIds).Select(x => new NodeLinkModel
            {
                LinkedNode = new NodeInfoModel { Id = x.id, Name = x.name! },
                LinkTypeId = x.linkId,
                LinkDirection = NodeLinkDirection.To
            });
        var linksBoth = bothIds.Select(x => new NodeLinkModel
            {
                LinkedNode = new NodeInfoModel { Id = x.id, Name = x.name! },
                LinkTypeId = x.linkId,
                LinkDirection = NodeLinkDirection.Both
            });
        return new NodeModel
            {
                Name = Node.Name,
                ImageUrl = Node.ImageUrl,
                TagIds = Node.NodeTags.Where(x => x.DeletedAt == null).Select(x => x.TagId).ToList(),
                NodeLinks = [..linksFrom, ..linksTo, ..linksBoth],
            };
    }

    private void AddLink()
    {
        _model.NodeLinks.Add(new NodeLinkModel());
    }

    private void DeleteLink(NodeLinkModel linkModel)
    {
        _model.NodeLinks.Remove(linkModel);
    }

    private async Task Save()
    {
        await _form.Validate();
        if (_form.IsValid && OnSave != null)
        {
            _model.TagIds ??= [];
            _model.NodeLinks ??= [];
            await OnSave.Invoke(Node.Id, _model);
            _isEditMode = false;
            RemapModel();
        }
    }

    private async Task Delete()
    {
        if (OnDelete != null)
            await OnDelete.Invoke(Node.Id);
    }

    private void CancelEdit()
    {
        _isEditMode = false;
        RemapModel();
    }

    private Task<IEnumerable<NodeInfoModel>> SearchNode(string value, CancellationToken token)
    {
        var nodes = string.IsNullOrEmpty(value) ? LinkableNodes : LinkableNodes.Where(x => x.Name!.Contains(value, StringComparison.InvariantCultureIgnoreCase));
        var result = nodes.Select(x => new NodeInfoModel { Id = x.Id, Name = x.Name! });
        return Task.FromResult(result);
    }

    private string GetTagsSelectText(List<string> selected)
    {
        var selectedInts = selected.Select(int.Parse).ToList();
        var tags = Node.Pack.Tags.Where(x => selectedInts.Contains(x.Id)).Select(x => x.Name);
        return string.Join(", ", tags);
    }

    private IEnumerable<string> GetTagNames(IEnumerable<int> tagIds)
    {
        var tagIdList = tagIds.ToList(); 
        return Node.Pack.Tags.Where(x => tagIdList.Contains(x.Id)).Select(x => x.Name!);
    }

    private string? GetLinkTypeName(int? id)
    {
        return Node.Pack.NodeLinkTypes.FirstOrDefault(x => x.Id == id)?.Name;
    }
}
