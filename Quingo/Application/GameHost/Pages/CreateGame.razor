@page "/game/host"

@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@inject ILogger<CreateGame> Logger
@inject ApplicationDbContext Db
@inject GameStateService StateService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@attribute [Authorize]

<PageTitle>Create Game</PageTitle>

<MudText Typo="Typo.h3" GutterBottom>Create Game</MudText>

<MudGrid>
    <MudItem xs="12" md="4">
        <MudSelect T="int?" Label="Select Pack" @bind-Value="@_selectedPackId" @bind-Value:after="OnPackSelected" Class="pb-4">
            @foreach (var pack in _packs)
            {
                <MudSelectItem T="int?" Value="@pack.Id">@pack.Name</MudSelectItem>
            }
        </MudSelect>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.PlayArrow" OnClick="StartGame" Disabled="_pack == null">Start Game</MudButton>
    </MudItem>
</MudGrid>

@code {
    [CascadingParameter(Name = "UserId")]
    public string UserId { get; set; } = default!;

    private List<Pack> _packs = [];


    private int? _selectedPackId;

    private Pack? _pack;

    protected override async Task OnInitializedAsync()
    {
        var exGame = StateService.Games.FirstOrDefault(x => x.HostUserId == UserId && x.State != GameStateEnum.Finished);
        if (exGame != null)
        {
            NavigationManager.NavigateTo($"/game/host/{exGame.GameSessionId}");
            return;
        }
        _packs = await Db.Packs.ToListAsync();
    }

    private async Task OnPackSelected()
    {
        _pack = await Db.Packs.FirstOrDefaultAsync(x => x.Id == _selectedPackId);
        if (_pack == null)
        {
            throw new Exception("Pack not found");
        }
    }

    private async Task StartGame()
    {
        try
        {
            ArgumentNullException.ThrowIfNull(_pack, nameof(_pack));
            ArgumentNullException.ThrowIfNull(UserId, nameof(UserId));

            var game = await StateService.StartGame(_pack.Id, UserId);
            NavigationManager.NavigateTo($"/game/host/{game.GameSessionId}");
        }
        catch (Exception e)
        {
            Logger.LogError(e, e.Message);
            Snackbar.Add(e.Message, Severity.Error);
        }
    }
}
