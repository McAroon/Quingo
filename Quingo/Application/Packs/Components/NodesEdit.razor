@inject ApplicationDbContext Db
@inject FileStoreService Files

<MudText Typo="Typo.h4" GutterBottom>
    Pack Items <MudTooltip Text="Add Item"><MudIconButton OnClick="AddNode" Icon="@Icons.Material.Filled.Add"></MudIconButton></MudTooltip>
</MudText>

<MudGrid>
    @if (Pack?.Nodes != null)
    @foreach(var node in Pack.Nodes.Where(x => x.DeletedAt == null))
    {
        <MudItem xs="12" md="6" lg="4">
            <NodeEdit Node="node" OnSave="SaveNode" OnDelete="DeleteNode" />
        </MudItem>
        <MudFlexBreak />
    }
</MudGrid>

@code {
    [CascadingParameter]
    public Pack Pack { get; set; } = default!;

    private async Task AddNode()
    {
        await SaveNode(0, new NodeModel());
    }

    private async Task SaveNode(int id, NodeModel model)
    {
        if (id == 0)
        {
            var node = new Node
            {
                Name = model.Name ?? "New Item",
                Pack = Pack
            };
            Db.Update(node);
        }
        else
        {
            var node = Pack.Nodes.FirstOrDefault(x => x.Id == id);
            if (node == null)
            {
                throw new Exception("Item not found"); // todo: proper error
            }

            node.Name = model.Name;

            foreach (var tagId in model.TagIds)
            {
                var nodeTag = node.NodeTags.FirstOrDefault(x => x.TagId == tagId);
                if (nodeTag == null)
                {
                    var tag = Pack.Tags.FirstOrDefault(x => x.Id == tagId);
                    if (tag == null)
                    {
                        throw new Exception("Tag not found"); // todo: proper error
                    }

                    nodeTag = new NodeTag
                    {
                        Node = node,
                        Tag = tag
                    };
                    node.NodeTags.Add(nodeTag);
                }
                else if (nodeTag.DeletedAt != null)
                {
                    nodeTag.DeletedAt = null;
                    nodeTag.DeletedByUserId = null;
                }
            }

            foreach (var nodeTag in node.NodeTags.Where(x => !model.TagIds.Contains(x.Tag.Id)))
            {
                Db.Remove(nodeTag);
            }

            foreach (var linkModel in model.NodeLinks)
            {
                if (linkModel.LinkDirection is NodeLinkDirection.From or NodeLinkDirection.Both)
                {
                    var link = node.NodeLinksFrom.FirstOrDefault(x => x.NodeToId == linkModel.LinkedNodeId);
                    var linkType = Pack.NodeLinkTypes.FirstOrDefault(x => x.Id == linkModel.LinkTypeId);
                    if (linkType == null)
                    {
                        throw new Exception("Link Type not found"); // todo: proper error
                    }

                    var linkedNode = Pack.Nodes.FirstOrDefault(x => x.Id == linkModel.LinkedNodeId);
                    if (linkedNode == null)
                    {
                        throw new Exception("Linked Item not found"); // todo: proper error
                    }

                    if (link == null)
                    {
                        link = new NodeLink
                        {
                            NodeFrom = node,
                            NodeTo = linkedNode,
                            NodeLinkType = linkType
                        };
                        node.NodeLinksFrom.Add(link);
                    }
                    else
                    {
                        if (link.NodeLinkTypeId != linkModel.LinkTypeId)
                        {
                            link.NodeLinkType = linkType;
                        }
                        if (link.DeletedAt != null)
                        {
                            link.DeletedAt = null;
                            link.DeletedByUserId = null;
                        }
                    }
                }

                if (linkModel.LinkDirection is NodeLinkDirection.To or NodeLinkDirection.Both)
                {
                    var link = node.NodeLinksTo.FirstOrDefault(x => x.NodeFromId == linkModel.LinkedNodeId);
                    var linkType = Pack.NodeLinkTypes.FirstOrDefault(x => x.Id == linkModel.LinkTypeId);
                    if (linkType == null)
                    {
                        throw new Exception("Link Type not found"); // todo: proper error
                    }

                    var linkedNode = Pack.Nodes.FirstOrDefault(x => x.Id == linkModel.LinkedNodeId);
                    if (linkedNode == null)
                    {
                        throw new Exception("Linked Item not found"); // todo: proper error
                    }

                    if (link == null)
                    {
                        link = new NodeLink
                            {
                                NodeFrom = linkedNode,
                                NodeTo = node,
                                NodeLinkType = linkType
                            };
                        node.NodeLinksTo.Add(link);
                    }
                    else
                    {
                        if (link.NodeLinkTypeId != linkModel.LinkTypeId)
                        {
                            link.NodeLinkType = linkType;
                        }
                        if (link.DeletedAt != null)
                        {
                            link.DeletedAt = null;
                            link.DeletedByUserId = null;
                        }
                    }
                }
            }

            foreach (var nodeLink in node.NodeLinksFrom)
            {
                var linkModel = model.NodeLinks.FirstOrDefault(x => x.LinkedNodeId == nodeLink.NodeTo.Id);
                if (linkModel == null)
                {
                    Db.Remove(nodeLink);
                }
            }

            foreach (var nodeLink in node.NodeLinksTo)
            {
                var linkModel = model.NodeLinks.FirstOrDefault(x => x.LinkedNodeId == nodeLink.NodeFrom.Id);
                if (linkModel == null)
                {
                    Db.Remove(nodeLink);
                }
            }

            if (model.ImageFile != null)
            {
                await Files.UploadBrowserFile(model.ImageFile);
                node.ImageUrl = model.ImageFile.Name;
            }
        }

        await Db.SaveChangesAsync();
        StateHasChanged();
    }

    private async Task DeleteNode(int id)
    {
        var node = Pack.Nodes.FirstOrDefault(x => x.Id == id);
        if (node == null)
        {
            throw new Exception("Item not found"); // todo: proper error
        }

        Db.Remove(node);
        await Db.SaveChangesAsync();
        StateHasChanged();
    }
}
