@using Quingo.Shared.Constants
@using MudBlazor
@using Quingo.Shared.Enums

<MudGrid>
    <MudItem xs="12">
        @if (IsEdit)
        {
            <MudCard>
                <MudCardContent>
                    <MudForm @ref="@_form">
                        <MudText Class="mud-input-label">Card Size*</MudText>
                        <MudStack Row Spacing="1" Class="mb-2">
                            @foreach (var size in new[] { 3, 4, 5 })
                            {
                                var s = size;
                                <MudButton Variant="@(GetCardSizeVariant(s))"
                                           Color="Color.Primary"
                                           OnClick="@(() => SetCardSize(s))">
                                    @($"{s}x{s}")
                                </MudButton>
                            }
                        </MudStack>
                        @if (SelectedTournamentMode == TournamentMode.ClassicPlayoff)
                        {
                            <MudSelect T="int" Label="Number of Players"
                                       @bind-Value="_model.MaxPlayers"
                                       Immediate="true"
                                       Dense="true">
                                @foreach (var value in new[] { 4, 8, 16, 32, 64, 128 })
                                {
                                    <MudSelectItem Value="@value">@value</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else if (SelectedTournamentMode != TournamentMode.QualificationAndPlayoff)
                        {
                            <MudNumericField @bind-Value="_model.MaxPlayers" Label="Number of Players"
                                             HelperText="Max number of players, 0 for unlimited" Min="0" />
                        }
                        <MudStack Class="mt-3">
                            <MudText Class="mud-input-label">Min Difficulty*</MudText>
                            <MudStack Row Spacing="1" Class="mb-2">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    var v = i;
                                    <MudButton Variant="@GetVariantForMin(v)"
                                               Color="Color.Primary"
                                               OnClick="@(() => SetMinDifficulty(v))">
                                        @v
                                    </MudButton>
                                }
                            </MudStack>
                        </MudStack>
                        <MudStack>
                            <MudText Class="mud-input-label">Max Difficulty*</MudText>
                            <MudStack Row Spacing="1" Class="mb-2">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    var v = i;
                                    <MudButton Variant="@GetVariantForMax(v)"
                                               Color="Color.Primary"
                                               OnClick="@(() => SetMaxDifficulty(v))">
                                        @v
                                    </MudButton>
                                }
                            </MudStack>
                        </MudStack>
                        <MudNumericField @bind-Value="_model.GameTimer" Label="Game Timer"
                                         HelperText="Game timer in seconds, 0 for no timer" Min="0" Max="60 * 10" />
                        <MudCheckBox @bind-Value="_model.SamePlayerCards" Label="Players have same Cards" />
                        <MudSelect T="PackPresetScoringRules" MultiSelection Label="Scoring Rules"
                                   @bind-SelectedValues="@_model.ScoringRules" ToStringFunc="x => x.GetName()">
                            @foreach (var rule in (PackPresetScoringRules[])
                                                    [
                                                    PackPresetScoringRules.CellScore,
                                                PackPresetScoringRules.PatternBonus,
                                                PackPresetScoringRules.TimeBonus,
                                                PackPresetScoringRules.CustomCellScore,
                                                PackPresetScoringRules.ErrorPenalty,
                                                PackPresetScoringRules.DrawPenalty,
                                                ])
                            {
                                <MudSelectItem T="PackPresetScoringRules" Value="rule">@rule.GetName()</MudSelectItem>
                            }
                        </MudSelect>
                    </MudForm>
                </MudCardContent>
                <MudCardActions>
                    <div class="ml-auto">
                        <MudButton Color="Color.Primary" OnClick="Save" StartIcon="@Icons.Material.Filled.Save">
                            Save
                            </MudButton>
                        <MudButton Color="Color.Secondary" OnClick="CancelEdit"
                                   StartIcon="@Icons.Material.Filled.Cancel">
                            Cancel
                        </MudButton>
                    </div>
                </MudCardActions>
            </MudCard>
        }
        else
        {
            <MudList T="string" ReadOnly>
                <MudListItem T="string">
                    <MudStack>
                        <MudText Typo="Typo.subtitle2">Card Size</MudText>
                        <MudStack Row Spacing="1">
                            @foreach (var s in new[] { 3, 4, 5 })
                            {
                                var size = s;
                                <MudButton Variant="@GetCardSizeVariant(size)"
                                           Disabled="true"
                                           Color="Color.Primary"
                                           Size="Size.Small">
                                    @($"{size}x{size}")
                                </MudButton>
                            }
                        </MudStack>
                    </MudStack>
                </MudListItem>

                @if (SelectedTournamentMode != TournamentMode.QualificationAndPlayoff)
                {
                    <MudListItem T="string">
                        <MudText Typo="Typo.subtitle2">Number of Players</MudText>
                        <MudText>@_model.MaxPlayers</MudText>
                    </MudListItem>
                }
                <MudListItem T="string">
                    <MudStack>
                        <MudText Typo="Typo.subtitle2">Min Difficulty</MudText>
                        <MudStack Row Spacing="1">
                            @for (int i = 1; i <= 5; i++)
                            {
                                var difficulty = i;
                                <MudButton Variant="@GetVariantForMin(difficulty)"
                                           Disabled="true"
                                           Color="Color.Primary"
                                           Size="Size.Small">
                                    @difficulty
                                </MudButton>
                            }
                        </MudStack>
                    </MudStack>
                </MudListItem>

                <MudListItem T="string">
                    <MudStack>
                        <MudText Typo="Typo.subtitle2">Max Difficulty</MudText>
                        <MudStack Row Spacing="1">
                            @for (int i = 1; i <= 5; i++)
                            {
                                var difficulty = i;
                                <MudButton Variant="@GetVariantForMax(difficulty)"
                                           Disabled="true"
                                           Color="Color.Primary"
                                           Size="Size.Small">
                                    @difficulty
                                </MudButton>
                            }
                        </MudStack>
                    </MudStack>
                </MudListItem>

                <MudListItem T="string">
                    <MudText Typo="Typo.subtitle2">Game Timer</MudText>
                    <MudText>@(_model.GameTimer > 0 ? $"{_model.GameTimer} sec" : "-")</MudText>
                </MudListItem>

                <MudListItem T="string">
                    <MudText Typo="Typo.subtitle2">Players have same Cards</MudText>
                    <MudText>@(_model.SamePlayerCards ? "Yes" : "No")</MudText>
                </MudListItem>

                <MudListItem T="string">
                    <MudText Typo="Typo.subtitle2">Scoring Rules</MudText>
                    <MudText>@GetScoringRuleNames(_model.ScoringRules)</MudText>
                </MudListItem>
            </MudList>
        }
    </MudItem>
</MudGrid>


@code {
    [Parameter, EditorRequired] public PackPreset Preset { get; set; } = default!;

    [Parameter] public bool IsEdit { get; set; }

    [Parameter] public Func<PackPresetData, Task>? OnSave { get; set; }

    [Parameter] public Action? OnCancelEdit { get; set; }

    [Parameter, EditorRequired] public Pack Pack { get; set; } = default!;

    [Parameter] public TournamentMode SelectedTournamentMode { get; set; }

    private MudForm _form = default!;

    private PackPresetDataModel _model = default!;

    private readonly int[] _allowedTournamentSizes = [4, 8, 16, 32, 64, 128];

    protected override void OnParametersSet()
    {
        _model = new PackPresetDataModel(Preset.Data);
        if (_model.CardSize is < 3 or > 5)
            _model.CardSize = 3;

        _model.MinDifficulty ??= 1;
        _model.MaxDifficulty ??= 5;

        if (_model.MinDifficulty > _model.MaxDifficulty)
            _model.MaxDifficulty = _model.MinDifficulty;
        if (_model.MaxDifficulty < _model.MinDifficulty)
            _model.MinDifficulty = _model.MaxDifficulty;

        if (SelectedTournamentMode == TournamentMode.ClassicPlayoff &&
            !_allowedTournamentSizes.Contains(_model.MaxPlayers))
        {
            _model.MaxPlayers = 4;
        }
        else if (SelectedTournamentMode == TournamentMode.QualificationAndPlayoff &&
            !_allowedTournamentSizes.Contains(_model.MaxPlayers))
        {
            _model.MaxPlayers = 128;
        }
    }

    private void OnCardSizeUpdated()
    {
        if (!_model.IsFreeCenterEnabled)
        {
            _model.FreeCenter = false;
        }

        _model.Columns.MatchListSize(_model.CardSize, i => new PackPresetColumnModel(i));
        OnColumnConfigUpdated(_model.Columns.First());
    }

    private void SetCardSize(int size)
    {
        if (_model.CardSize == size) return;
        _model.CardSize = size;
        OnCardSizeUpdated();
        StateHasChanged();
    }

    private Variant GetCardSizeVariant(int size) => _model.CardSize == size ? Variant.Filled : Variant.Outlined;

    private void SetMinDifficulty(int value)
    {
        _model.MinDifficulty = value;
        if ((_model.MaxDifficulty ?? 5) < value)
            _model.MaxDifficulty = value;
        StateHasChanged();
    }

    private void SetMaxDifficulty(int value)
    {
        _model.MaxDifficulty = value;
        if ((_model.MinDifficulty ?? 1) > value)
            _model.MinDifficulty = value;
        StateHasChanged();
    }

    private Variant GetVariantForMin(int value) => (_model.MinDifficulty ?? 1) == value ? Variant.Filled : Variant.Outlined;

    private Variant GetVariantForMax(int value) => (_model.MaxDifficulty ?? 5) == value ? Variant.Filled : Variant.Outlined;

    private string GetTagsSelectText(IList<string> selected)
    {
        return GetTagsSelectText(selected.Select(int.Parse));
    }

    private string GetTagsSelectText(IEnumerable<int> selected)
    {
        var selectedList = selected.ToList();
        var tags = Pack.Tags.Where(x => selectedList.Contains(x.Id)).Select(x => x.Name).ToList();
        return tags.Count > 0 ? string.Join(", ", tags) : "-";
    }

    private string? GetTagName(int tagId) => Pack.Tags.FirstOrDefault(x => x.Id == tagId)?.Name;

    private string GetScoringRuleNames(IEnumerable<PackPresetScoringRules> rules) => string.Join(", ", rules.Select(x => x.GetName()));

    private void OnColumnConfigUpdated(PackPresetColumnModel col)
    {
        if (!_model.SingleColumnConfig || _model.Columns.IndexOf(col) != 0) return;
        foreach (var pCol in _model.Columns.Skip(1))
        {
            pCol.QuestionTags = [..col.QuestionTags];
            pCol.AnswerTags = [..col.AnswerTags];
            pCol.ExcludeTags = [..col.ExcludeTags];
        }

        StateHasChanged();
    }

    private async Task Save()
    {
        await _form.Validate();
        if (_form.IsValid && OnSave != null)
        {
            await OnSave(_model.ToData());
        }
    }

    private void CancelEdit()
    {
        OnCancelEdit?.Invoke();
        _model = new PackPresetDataModel(Preset.Data);
        StateHasChanged();
    }
}